ЗАДАЧА 4.1
  SELECT  a.city,
          count(a.airport_code) AS count_airports_in_city
    FROM  dst_project.airports a
GROUP BY  a.city
ORDER BY  count_airports_in_city DESC

ОТВЕТ:
Moscow    3
Ulyanovsk 2



ЗАДАЧА 4.2.1
  SELECT  count(distinct f.status) as flight_status_count
    FROM  dst_project.flights f

ОТВЕТ:
flight_status_count
6



ЗАДАЧА 4.2.2
  SELECT  count(f.status) as flight_status_count
    FROM  dst_project.flights f
   WHERE  f.status='Departed'

ОТВЕТ:
flight_status_count
58



ЗАДАЧА 4.2.3
  SELECT  a.model, count(s.seat_no) AS  seat_count
    FROM  dst_project.seats AS s 
            JOIN dst_project.aircrafts AS a 
            ON s.aircraft_code=a.aircraft_code
   WHERE  a.model LIKE 'Boeing 777%'
GROUP BY  a.model

ОТВЕТ:
model              seat_count   
Boeing 777-300     402



ЗАДАЧА 4.2.4
  SELECT  count(f.flight_id)
    FROM  dst_project.flights f
   WHERE  f.status='Arrived' 
          AND (scheduled_arrival BETWEEN '2017-04-01' AND '2017-09-01')

ОТВЕТ:
74,227



ЗАДАЧА 4.3.1
  SELECT  count(f.flight_id)
    FROM  dst_project.flights f
   WHERE  f.status='Cancelled'

ОТВЕТ:
437 



ЗАДАЧА 4.3.2
  SELECT  a.model, count(a.aircraft_code) AS  model_count
    FROM  dst_project.aircrafts AS a 
   WHERE  a.model LIKE 'Airbus%'
GROUP BY  a.model

ОТВЕТ:
model           model_count
Airbus A319-100 1
Airbus A320-200 1
Airbus A321-200 1



ЗАДАЧА 4.3.3
  SELECT  'Europe' part, count(a.airport_code) 
    FROM  dst_project.airports AS a 
   WHERE  a.timezone LIKE 'Europe%'
   UNION         
  SELECT  'Asia' part, count(a.airport_code) 
    FROM  dst_project.airports AS a 
   WHERE  a.timezone LIKE 'Asia%'

ОТВЕТ:
part     Количество
Asia     52
Europe   52



ЗАДАЧА 4.3.4
   SELECT  f.flight_id, f.scheduled_arrival - f.actual_arrival AS delay
     FROM  dst_project.flights f 
UNION ALL
   SELECT  f.flight_id, f.scheduled_departure - f.actual_departure AS delay
     FROM  dst_project.flights f 
 ORDER BY delay
    LIMIT 5  

ОТВЕТ:
flight_id delay
157,571   0 years 0 mons 0 days -5 hours -7 mins -0.00 secs
157,571   0 years 0 mons 0 days -5 hours -3 mins -0.00 secs
126,166   0 years 0 mons 0 days -4 hours -44 mins -0.00 secs
186,524   0 years 0 mons 0 days -4 hours -44 mins -0.00 secs
186,524   0 years 0 mons 0 days -4 hours -44 mins -0.00 secs



ЗАДАЧА 4.4.1
   SELECT min(f.scheduled_departure) 
      
     FROM  dst_project.flights f 

ОТВЕТ:
август 14, 2016, 11:45 вечера



ЗАДАЧА 4.4.2
   SELECT  EXTRACT(HOUR FROM max(f.scheduled_arrival - f.scheduled_departure))*60 + 
           EXTRACT(MINUTE FROM max(f.scheduled_arrival - f.scheduled_departure))
     FROM  dst_project.flights f 

ОТВЕТ:
530



ЗАДАЧА 4.4.3
   SELECT f.departure_airport, f.arrival_airport, max(f.scheduled_arrival - f.scheduled_departure)
      
     FROM  dst_project.flights f 
WHERE (f.scheduled_arrival - f.scheduled_departure) = (SELECT max(f.scheduled_arrival - f.scheduled_departure) FROM  dst_project.flights f)
GROUP BY  f.departure_airport, f.arrival_airport

ОТВЕТ:
departure_airport arrival_airport   max
DME               PKC               0 years 0 mons 0 days 8 hours 50 mins 0.00 secs
DME               UUS               0 years 0 mons 0 days 8 hours 50 mins 0.00 secs
PKC               DME               0 years 0 mons 0 days 8 hours 50 mins 0.00 secs
UUS               DME               0 years 0 mons 0 days 8 hours 50 mins 0.00 secs



ЗАДАЧА 4.4.4
 SELECT EXTRACT(HOUR FROM AVG(f.actual_arrival - f.actual_departure))*60+
          EXTRACT(MINUTE FROM AVG(f.actual_arrival - f.actual_departure))
     FROM  dst_project.flights f

ОТВЕТ:
128



ЗАДАЧА 4.5.1
  SELECT s.fare_conditions, COUNT(s.seat_no)
    FROM dst_project.seats s
   WHERE s.aircraft_code='SU9'
GROUP BY s.fare_conditions

ОТВЕТ:
fare_conditions количество
Business        12
Economy         85



ЗАДАЧА 4.5.2
  SELECT 'min booking', min(b.total_amount)
    FROM dst_project.bookings b

ОТВЕТ:
min booking 3,400 



ЗАДАЧА 4.5.3
  SELECT 'seat_no', b.seat_no
    FROM dst_project.tickets  t
          JOIN dst_project.ticket_flights  tf ON t.ticket_no = tf.ticket_no
          JOIN dst_project.boarding_passes b ON t.ticket_no = b.ticket_no
   WHERE t.passenger_id = '4313 788533' 

ОТВЕТ:
seat_no 2A



ЗАДАЧА 5.1.1
  SELECT 'Anapa arrival count', count(*)
    FROM dst_project.flights  f
          LEFT JOIN dst_project.airports a ON f.arrival_airport = a.airport_code
         
   WHERE a.city = 'Anapa' and actual_arrival BETWEEN '2017-01-01' AND '2017-12-31'

ОТВЕТ:
Anapa arrival count 486



ЗАДАЧА 5.1.2
  SELECT 'Anapa departure count',count(*)
    FROM dst_project.flights  f
          LEFT JOIN dst_project.airports a ON f.departure_airport = a.airport_code
         
   WHERE a.city = 'Anapa' AND ((f.actual_departure BETWEEN '2017-01-01 00:00:00' AND '2017-02-28 23:59:59') 
                            OR (f.actual_departure BETWEEN '2017-12-01 00:00:00' AND '2017-12-31 23:59:59'))

ОТВЕТ:
Anapa departure count 127



ЗАДАЧА 5.1.3
  SELECT 'Anapa cancelled count',count(*)
    FROM dst_project.flights  f
          LEFT JOIN dst_project.airports a ON f.departure_airport = a.airport_code
         
   WHERE a.city = 'Anapa' AND f.status = 'Cancelled'

ОТВЕТ:
Anapa cancelled count 1



ЗАДАЧА 5.1.4
SELECT count(*)
FROM dst_project.flights AS f
WHERE  f.arrival_airport NOT IN (SELECT a.airport_code 
                                    FROM  dst_project.airports AS a  
                                    WHERE a.city = 'Moscow')    
        AND f.departure_airport = (SELECT a.airport_code 
                                    FROM  dst_project.airports AS a  
                                    WHERE a.city = 'Anapa')

ОТВЕТ:
453


ЗАДАЧА 5.1.5

 SELECT model, count(s.seat_no) AS seat_count
   FROM dst_project.aircrafts AS a
         LEFT JOIN dst_project.seats AS s  
          ON a.aircraft_code = s.aircraft_code
          LEFT JOIN dst_project.flights AS f 
          ON a.aircraft_code = f.aircraft_code
        
   WHERE  f.departure_airport = (SELECT air.airport_code 
                                    FROM  dst_project.airports AS air  
                                    WHERE air.city = 'Anapa')
GROUP BY a.model, f.flight_id
ORDER BY 2 DESC

ОТВЕТ:
model            seat_count
Boeing 737-300   130
Boeing 737-300   130
Boeing 737-300   130
Boeing 737-300   130
Boeing 737-300   130
...





ЗАПРОС ПО МОДУЛЮ 4

/* В связи с тем, что в рейсах в аэропорт прилета NOZ нет данных о количестве проданных билетов и их стоимости я пытался вытащить эту  информацию из всех таблиц, но увы ... */
WITH amount AS  
   (  SELECT sum(tf.amount) AS total_amount,
             tf.flight_id
        FROM dst_project.ticket_flights AS tf
    GROUP BY tf.flight_id
    ),                                              --стоимость пролданных билетов на рейс (ticket_flights)
    
    seat_sold AS 
   (  SELECT count(bp.seat_no) AS total_seat_sold,
             bp.flight_id
        FROM dst_project.boarding_passes AS bp
    GROUP BY bp.flight_id
    ),                                              -- количество проданных всего  мест на рейс на основании таблицы посадочных талонов (boarding_passes)
    
    ticket_by_class AS 
   (  SELECT tf1.flight_id,
             count(CASE WHEN tf1.fare_conditions = 'Economy' THEN tf1.fare_conditions
                   END) AS ticket_economy,
             count(CASE WHEN tf1.fare_conditions = 'Comfort' THEN tf1.fare_conditions
                   END) AS ticket_comfort,
             count(CASE WHEN tf1.fare_conditions = 'Business' THEN tf1.fare_conditions
                   END) AS ticket_bisiness
        FROM dst_project.ticket_flights AS tf1
    GROUP BY 1
    ),                                              -- количество проданных мест по  классам обслуживания на оснвоании таблицы перелетов (ticket_flights)
     
    pass AS                                        
   (  SELECT tf.flight_id, count(t.passenger_id) AS passenger_count
             FROM dst_project.ticket_flights AS tf 
             FULL JOIN dst_project.tickets AS t ON t.ticket_no = tf.ticket_no
           GROUP BY 1 
    ),                                              -- количество пассажиров на рейсе на оснвоании таблицы билетов (Tickets)
   
      amount_of_bookings AS                                        
   (  SELECT tf.flight_id, sum(b.total_amount) AS total_amount
             FROM dst_project.ticket_flights AS tf 
             LEFT JOIN dst_project.tickets AS t ON t.ticket_no = tf.ticket_no
             LEFT JOIN dst_project.bookings AS b ON b.book_ref = t.book_ref
           GROUP BY 1 
    ),                                              --стоимость проданных билетов на рейс (bookings) 
   
   timez AS
   ( SELECT a.airport_code, a.city,
            CASE WHEN a.timezone = 'Asia/Anadyr'        THEN 11 
                 WHEN a.timezone = 'Asia/Chita'         THEN 9  
                 WHEN a.timezone = 'Asia/Irkutsk'       THEN 8  
                 WHEN a.timezone = 'Asia/Kamchatka'     THEN 11 
                 WHEN a.timezone = 'Asia/Krasnoyarsk'   THEN 7  
                 WHEN a.timezone = 'Asia/Magadan'       THEN 11 
                 WHEN a.timezone = 'Asia/Novokuznetsk'  THEN 6  
                 WHEN a.timezone = 'Asia/Novosibirsk'   THEN 6  
                 WHEN a.timezone = 'Asia/Omsk'          THEN 6  
                 WHEN a.timezone = 'Asia/Sakhalin'      THEN 10 
                 WHEN a.timezone = 'Asia/Vladivostok'   THEN 10 
                 WHEN a.timezone = 'Asia/Yakutsk'       THEN 9  
                 WHEN a.timezone = 'Asia/Yekaterinburg' THEN 5  
                 WHEN a.timezone = 'Europe/Kaliningrad' THEN 2  
                 WHEN a.timezone = 'Europe/Moscow'      THEN 3  
                 WHEN a.timezone = 'Europe/Samara'      THEN 3  
                 WHEN a.timezone = 'Europe/Volgograd'   THEN 3  END AS GMT_plus
        FROM dst_project.airports AS a
   )
    
SELECT f.flight_id,                                 --номер рейса
       f.departure_airport,                         -- аэропорт вылета
       f.arrival_airport,                           -- аэропорт прилета
       f.status,                                    -- статус рейса
       arp.city,                                    --город прилета
       
       EXTRACT(HOUR FROM (f.actual_arrival - f.actual_departure))*60 + 
           EXTRACT(MINUTE FROM (f.actual_arrival - f.actual_departure))-(arp.GMT_plus - arp2.GMT_plus)*60  AS duration,  
                                                    -- duration - длительность полета в минутах, с учетом часовых поясов
       
       concat_ws('',extract(isoyear  from f.actual_departure) || '-', 
                    extract(MONTH  from f.actual_departure) || '-',  
                    extract(DAY  from f.actual_departure)) AS departure_day,
                                                    -- дата вылета
       
       concat_ws('',      extract(hours from f.actual_departure)|| ':', 
                         extract(minutes from f.actual_departure)|| '') AS departure_time,
                                                    -- время вылета
                         
       extract(ISODOW  from f.actual_departure) AS departure_day_of_week,
                                                    -- день недели вылета
       arc.model,                                   -- модель самолета
       (SELECT count(s.seat_no) AS total_seats
          FROM dst_project.seats AS s
         WHERE s.aircraft_code = f.aircraft_code 
        ),                                          -- количество посадочных мест в данной модели самолета
        amount.total_amount,                        -- стоимсть проданных билетов (на основании таблицы ticket_flights) 
        amount_of_bookings.total_amount,            -- стоимсть проданных билетов (на основании таблицы bookings)
        seat_sold.total_seat_sold,                  -- всего продано билетов (на основании таблицы boarding_passes)
        ticket_by_class.ticket_economy,             -- продано билетов в класс economy (на основании таблицы ticket_flights)
        ticket_by_class.ticket_comfort,             -- продано билетов в класс comfort (на основании таблицы ticket_flights)
        ticket_by_class.ticket_bisiness,            -- продано билетов в класс bisiness (на основании таблицы ticket_flights)
        pass.passenger_count                        -- количество проданных билетов (на основании таблицы tickets)
        
  FROM dst_project.flights AS f
       LEFT JOIN dst_project.aircrafts AS arc ON arc.aircraft_code = f.aircraft_code
       LEFT JOIN timez AS arp ON arp.airport_code = f.arrival_airport
       LEFT JOIN timez AS arp2 ON arp2.airport_code = f.departure_airport
       LEFT JOIN amount ON amount.flight_id = f.flight_id
       LEFT JOIN  amount_of_bookings ON  amount_of_bookings.flight_id = f.flight_id
       LEFT JOIN seat_sold ON seat_sold.flight_id = f.flight_id
       LEFT JOIN ticket_by_class ON ticket_by_class.flight_id = f.flight_id
       LEFT JOIN pass ON pass.flight_id = f.flight_id
        
    
 WHERE f.departure_airport = 'AAQ'
       AND (date_trunc('month', f.scheduled_departure) in ('2017-01-01', '2017-02-01', '2017-12-01'))
       AND f.status not in ('Cancelled')